<!doctype html>
<html lang="en-US">
    <head>  
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1 minimal-ui" />
        <title>Markdown Editor</title>
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
        <link rel="stylesheet" href="public/css/flex_style.css" />
        
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">        <!-- Optional theme -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
        <link type="text/css" rel="stylesheet" href="public/css/github-markdown.css">
        <link type="text/css" rel="stylesheet" href="public/css/pilcrow.css">
        <link type="text/css" rel="stylesheet" href="public/css/hljs-github.min.css"/>
    </head>
    <body>
        <header>
            <nav class="navbar navbar-inverse navbar-fixed-top">
                <div class="container-fluid">
                    <!-- Brand and toggle get grouped for better mobile display -->
                    
                    <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" id="my-logo" href="https://github.com/daveying">
                        <img id="my-logo-img-gray" src="logo/logo-transparent-35x35gray.png" alt="logo gray" />
                        <img id="my-logo-img-white" style="display: none" src="logo/logo-transparent-35x35white.png" alt="logo white" />
                    </a>
                    <a class="navbar-brand" href="https://github.com/daveying/Markdown-Editor">Markdown-Editor</a>
                    </div>
                    
                    <!-- Collect the nav links, forms, and other content for toggling -->
                    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav">
                        <li class="active2"><a href="#" onclick="previewClickHandler()">Cache <span class="sr-only">(current)</span></a></li>
                        <li><a href="#" onclick="saveClickHandler()">Save</a></li>
                        <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Settings <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="#" onclick="smFontClieckedHandler()">Small Font</a></li>
                            <li><a href="#" onclick="mdFontClieckedHandler()">Medium Font</a></li>
                            <li><a href="#" onclick="lgFontClieckedHandler()">Large Font</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="#">Github style</a></li>
                            <li><a href="#">Other style</a></li>
                            <!--<li role="separator" class="divider"></li>
                            <li><a href="#">One more separated link</a></li>-->
                        </ul>
                        </li>
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li><a href="http://ife2017.xpda.me">About</a></li>
                        <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Other Apps <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="#">Blog</a></li>
                            <!--<li><a href="#">Another action</a></li>
                            <li><a href="#">Something else here</a></li>-->
                            <!--<li role="separator" class="divider"></li>
                            <li><a href="#">Separated link</a></li>-->
                        </ul>
                        </li>
                    </ul>
                    </div><!-- /.navbar-collapse -->
                </div><!-- /.container-fluid -->
            </nav>
        </header>
        <main id="main-content">
            <div id="editor"># Markdown Editor
This markdown editor is developed by [Dave Da](https://github.com/daveying).

You can find source code [here](https://github.com/daveying/Markdown-Editor).</div>
            <div id="dragger"></div>
            <div id="preview">
                <div id="markdown-div" class="markdown-body">
                </div>
            </div>
        </main>
        <footer class="bg-4">
            <div>
                <em>Developed by Dave Da(<a href="https://github.com/daveying">https://github.com/daveying</a>). &copy 2017</em>
            </div>
        </footer>
        <form id="mdStr" name="mdStr" action="/parseMdStr" method="post" target="_blank" style="visibility: hidden">
            <textarea id="fakeMd" name="fakeMd" rows="3" cols="3">
            </textarea>
            <input id="saveOrPreview" type="text" name="saveOrPreview"></input> 
            <input id="randomName" type = "text" name="randomName"></input>
        </form>
        <script src="public/ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="node_modules/markdown-it/dist/markdown-it.js"></script>
        <script src="public/highlight.js/highlight.pack.js"></script>
        <script>
            var languageOverrides = {
                js: 'javascript',
                html: 'xml'
            };
            var md = markdownit({
                html: true,
                linkify: false,
                highlight: function(code, lang) {
                    if(languageOverrides[lang]) lang = languageOverrides[lang];
                    if(lang && hljs.getLanguage(lang)){
                        try {
                            return hljs.highlight(lang, code).value;;
                        }catch(e){}
                    }
                    return '';
                }
            });
            var editor = ace.edit("editor");
            editor.setTheme("ace/theme/chrome");
            editor.session.setMode("ace/mode/markdown");
            editor.container.style.lineHeight = 1.5;
            editor.getSession().setUseWrapMode(true);
            if(localStorage.getItem('md-content')) {
                editor.setValue(localStorage.getItem('md-content'));
                editor.gotoLine(1);
            }
            var previewClickHandler = function () {
                var mdStr = editor.getValue();
                document.getElementById('fakeMd').innerHTML = mdStr;
                //console.log(mdStr);
                localStorage.setItem('md-content', mdStr);
                document.getElementById('saveOrPreview').value = "preview";
                //document.forms["mdStr"].submit();
                document.getElementById('markdown-div').innerHTML = md.render(mdStr);
            }
            var saveClickHandler = function () {
                var mdStr = editor.getValue();
                document.getElementById('fakeMd').innerHTML = mdStr;
                //console.log(mdStr);
                localStorage.setItem('md-content', mdStr);
                document.getElementById('saveOrPreview').value = "save";
                var d = new Date();
                document.getElementById('randomName').value = d.getTime().toString() + Math.round((Math.random() * 10000)).toString();
                document.forms["mdStr"].submit();
            }
            var smFontClieckedHandler = function () {
                document.getElementById('editor').style.fontSize='12px';
            }
            var mdFontClieckedHandler = function () {
                document.getElementById('editor').style.fontSize='16px';
            }
            var lgFontClieckedHandler = function () {
                document.getElementById('editor').style.fontSize='18px';
            }
            editor.getSession().on('change', function(e) {
                var mdStr = editor.getValue();
                var markdownDiv = document.getElementById('markdown-div');
                var previewDiv = document.getElementById('preview');
                var old = markdownDiv.cloneNode(true);
                markdownDiv.innerHTML = md.render(mdStr);

                var allold = old.getElementsByTagName("*");
                var allnew = markdownDiv.getElementsByTagName("*");
                for(var i = 0, max = Math.min(allold.length, allnew.length); i < max; i++) {
                    if(!allold[i].isEqualNode(allnew[i])) {
                        previewDiv.scrollTop = allnew[i].offsetTop;
                    }
                }
            });

            //resize window
            var flag = false;
            var draggerDiv = document.getElementById("dragger");
            var editorDiv = document.getElementById("editor");
            var previewDiv = document.getElementById("preview");
            draggerDiv.onmousedown = function (event) {
                flag = true;
            }
            document.onmouseup = function (event) {
                flag = false;
            }
            document.onmousemove = function (event) {
                if (!event) event = window.event;
                if (flag) {
                    var w = document.body.scrollWidth;
                    var h = document.body.scrollHeight;
                    var x = event.clientX;
                    var y = event.clientY;
                    editorDiv.style['flex'] = `${x / w}`;
                    editorDiv.style['-webkit-flex'] = `${x / w}`;
                    previewDiv.style['flex'] = `${1- x / w}`;
                    previewDiv.style['-webkit-flex'] = `${1- x / w}`;
                    
                    // when the size of editor div changes, 
                    // ace wrap point will not be updated, 
                    // so switch on wrap mode again to solve this problem
                    editor.getSession().setUseWrapMode(false);
                    editor.getSession().setUseWrapMode(true);
                }
            }

            // logo change
            var logoA = document.getElementById('my-logo');
            var logoImgGray = document.getElementById('my-logo-img-gray');
            var logoImgWhite = document.getElementById('my-logo-img-white');
            var originalStyle = logoImgGray.style['display'];
            logoA.onmouseover = function (event) {
                logoImgGray.style['display'] = "none";
                logoImgWhite.style['display'] = originalStyle;
            }
            logoA.onmouseout = function (event) {
                logoImgWhite.style['display'] = "none";
                logoImgGray.style['display'] = originalStyle;
            }
        </script>
        <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.2.1.min.js"></script>

        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    </body>
</html>